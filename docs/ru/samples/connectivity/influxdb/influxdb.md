# Загрузка данных в InfluxDB (HTTPS)

Документ: Спецификация обмена данными Faceplate → InfluxDB  
Версия: 1.0

## 1. Архитектура решения



## 4. Пример реализации загрузки данных в InfluxDB

Пример представляет собой прикладной проект с решением для загрузки данных в Influxdb основаный на стандартных инструментах Faceplate. Для лучшего понимания рекомендуется ознакомится со следующими компонентами:
    - prtotypes
    - primitives
    - iot_connections
    - global_modules

Для загрузки проекта необходимо [скачать].(https:github.com/faceplate-docs/faceplate/prototypes/connectivity/influxdb) экспорт-файл и импортировать в Faceplate.

### 4.1 Необходимое окружение

Проект представляет собой разработанное в стандартных редакторах Faceplate решение реализующую следующий функционал:
    1. Сбор данных с объектов помеченных для отправки в экземпляр influxdb.
    2. Необходимое преобразование данных и формирование сообщения в формате Line Protocol
    3. Отправка данных через HTTP(S) соединение на указанный адрес с подтверждением доставки данных (код 204).

### 4.2 Импорт проекта и его настройка
1. Для начала настройки окружения проекта необходимо скачать и импортировать в проект Faceplate.
2. После завершения импорта в списке доступных прототипов должен появиться элементы с названием influxdb, pump, sensor, где:
    a. influxdb - прототип содержащий все необходимые механизмы для обмена данными с экземпляром InfluxDB;
    b. pump - объект для представления насоса как объекта в иерархии проекта;
    c. sensor - объект для представления одной точки измерения.
Описание перечисленных прототипов приведены в отделе [prototypes](docs/ru/samples/prptotypes). 
3. В дереве проекта должен появиться структура с объектами описывающими иерархию:

<иерархия проекта>/<объект мониторинга>/<набор сенсоров>

где area это директория группирирующая объекты мониторинга относительно их физического или логического расположения, например:

"станция А/pump #1/расход"

Эта иерархия служит основой для формирования относительно директории **цех** точки для формирования телеграммы и записи в InfluxDB в формате Line Protocol:

<объект мониторинга>,<имя тега>=<значение тега> <имя сенсора>=<значение сенсора> timestamp

Объект influxdb спроектирован так, что находит все указанные типы объектов и группирует расположенные внутри них объекты sensor в единный блок данных далее преобразуя сообщения.

Для того что бы передать уникальность объекта мониторинга нужно использовать теги <имя тега>=<значение тега>. На стороне InfluxDB теги используются при формировании фильтра при запросе данных. Таким образом можно сформировать сообщение относительно любой структуры проекта, указав необходимое количество тегов в сообщении.

### Масштабирование

Процесс масштабирования основан на добавлении в необходимые директории дерева проекта прототипов influxdb и pump.

Оба рототипа могут быть расширены пользователем для решения дполнительных задач и представлены в ознакомительных целях.

Рекомендация: отправлять данные пачками (batch writing) — по 500–1000 строк в одном запросе для оптимальной производительности.

## 5. Безопасность и отказоустойчивость

- Проверка сертификатов: убедитесь, что на сервере Faceplate установлены корневые CA для проверки SSL-сертификата InfluxDB.
- Буферизация: при потере связи данные сохраняются в локальный буфер для сохранения точек до восстановления соединения.