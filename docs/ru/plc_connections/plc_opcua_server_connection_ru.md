# Руководство по конфигурации OPC UA Server

## Общее описание
Драйвер **OPC UA Server** позволяет системе **Faceplate** выступать в роли сервера OPC UA. Это означает, что система публикует свои внутренние теги во внешнюю сеть, позволяя сторонним клиентам (SCADA, MES, ERP, UaExpert) подключаться, считывать и записывать данные по протоколу `opc.tcp`.

Процесс настройки состоит из двух этапов:
1.  **Connection (`plc_opcua_server_connection`):** Настройка сетевого интерфейса (Endpoint) и параметров сервера.
2.  **Binding (`plc_opcua_server_binding`):** Публикация конкретных тегов в адресное пространство сервера.

---

## ШАГ 1. Настройка соединения (Connection)

На этом этапе определяется, на каком порту и интерфейсе сервер будет ожидать входящие подключения.

![Настройка соединения OPC UA Server](images/opcua_server_conn.png)

### 1.1 Панель диагностики (Runtime)
Верхняя часть окна отображает текущий статус процесса сервера.

| Поле | Описание |
| :--- | :--- |
| **State** | Текущее состояние драйвера. **STOP** — сервер остановлен, порт закрыт. **RUN** — сервер запущен и принимает соединения. |
| **Node** | Имя узла кластера, на котором запущен процесс. |
| **PID** | Идентификатор процесса (Process ID) в операционной системе. |
| **Disabled** | Переключатель для глобального отключения экземпляра сервера. |
| **Error** | Текст последней ошибки (например, если порт занят другим приложением). |
| **Memory limit (bytes)** | Лимит оперативной памяти, выделяемой для процесса сервера. |

### 1.2 Параметры конфигурации (Settings)

#### Основные настройки
| Параметр | Описание |
| :--- | :--- |
| **Name** | Уникальное системное имя соединения. |
| **Title** | Пользовательское описание соединения. |
| **Actual connection** | Информационное поле, показывающее активное соединение (актуально при резервировании). |
| **Master connection** | Ссылка на основное соединение. Заполняется только при настройке резервного сервера. |
| **Period (ms)** | Внутренний цикл обработки сервера. |
| **Shutdown timeout (ms)** | Время ожидания корректного завершения сессий клиентов перед принудительной остановкой сервера. |

#### Оптимизация протокола
| Параметр | Описание |
| :--- | :--- |
| **Support for group requests** | **Yes** — разрешить клиентам использовать групповые подписки (Monitored Items). Рекомендуется для производительности. |
| **Max. package length** | Максимальный размер пакета данных (в байтах). |
| **Line Delay Ratio** | Коэффициент задержки линии (используется для расчета таймаутов на медленных сетях). |

#### Сетевые настройки (Вкладка TCP)
| Поле | Описание |
| :--- | :--- |
| **IP/Hostname/Localhost** | IP-адрес интерфейса, который будет слушать сервер.<br>• `127.0.0.1` — доступ только локально.<br>• `0.0.0.0` — доступен для всех внешних клиентов. |
| **Port** | TCP-порт для входящих подключений. По умолчанию **4841**. |
| **Timeout** | Таймаут сетевых операций (мс). |

> Примечание: Вкладки **Users** (Пользователи), **Шифрование** (Сертификаты) и **Ограничения** используются для настройки политик безопасности.

---

## ШАГ 2. Настройка переменных (Binding)

Этот этап определяет "Адресное пространство" (Address Space) вашего сервера. Каждый объект binding создает узел (Node), видимый внешним клиентам.

![Настройка переменных OPC UA Server](images/opcua_server_bindings.png)

### 2.1 Управление (Runtime)
| Поле | Описание |
| :--- | :--- |
| **State** | Статус конкретной привязки. |
| **Off** | Переключатель для временного скрытия узла из адресного пространства без удаления настроек. |

### 2.2 Параметры привязки
| Поле | Описание |
| :--- | :--- |
| **Name** | Системное имя объекта привязки. |
| **Title** | Описание переменной. |
| **Tag** | **Исходный тег.** Внутренний тег системы Faceplate, значение которого будет опубликовано. |
| **Transformation** | Опциональное преобразование данных (масштабирование, инверсия) перед отправкой клиенту. |
| **Access** | Уровень доступа для внешних клиентов:<br>• **R** — Только чтение (Клиент видит значение, но не может менять).<br>• **RW** — Чтение и запись (Клиент может управлять этим тегом). |
| **OPC tag** | **Имя узла (NodeId).** Имя, под которым переменная будет видна в дереве OPC UA сервера.<br>Пример: `Sensor1` или `Area1.Temp`. |
| **Type** | Тип данных узла OPC UA (Double, Int32, Boolean и т.д.). Если не задано, наследуется от исходного тега. |

---
<!-- 
## Дополнительно

1.  **Настройка Firewall:** Убедитесь, что TCP порт (по умолчанию 4841) открыт для входящих соединений в брандмауэре сервера.
2.  **Endpoint URL:** Клиенты должны подключаться по адресу формата `opc.tcp://<IP_Сервера>:4841`.
3.  **Уникальность имен:** Значение поля **OPC tag** должно быть уникальным в рамках одного сервера.
4.  **IP-адрес:** Для доступа с других компьютеров в поле IP необходимо указать `0.0.0.0` или конкретный IP сетевой карты, а не `127.0.0.1`. -->