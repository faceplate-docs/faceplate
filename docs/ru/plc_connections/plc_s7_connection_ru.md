# Руководство по конфигурации S7 (ISO-on-TCP)

## Общее описание
Драйвер **S7** предназначен для нативного обмена данными с программируемыми логическими контроллерами (ПЛК) компании Siemens семейства **Simatic S7**.

Поддерживаемые серии:
* **S7-300 / S7-400** (Классическая архитектура).
* **S7-1200 / S7-1500** (Современные серии, требуют настройки доступа, см. раздел Troubleshooting).
* **Siemens Logo!** (начиная с версий 0BA7/0BA8).

Обмен данными происходит по протоколу **ISO-on-TCP** (RFC 1006) через стандартный порт **102**.

Процесс настройки состоит из двух этапов:
1.  **Connection (`plc_s7_connection`):** Настройка сетевого доступа к CPU.
2.  **Binding (`plc_s7_binding`):** Адресация конкретной ячейки памяти.

---

## ШАГ 1. Настройка соединения (Connection)

На этом этапе мы настраиваем параметры подключения к коммуникационному процессору или порту Ethernet на CPU.

### 1.1 Панель диагностики (Runtime)
*Верхняя часть окна. Служит для мониторинга состояния.*

| Поле | Описание |
| :--- | :--- |
| **State** | **STOP** (Красный) — драйвер остановлен.<br>**RUN** (Зеленый) — соединение установлено (Handshake прошел успешно). |
| **Error** | Текст ошибки. <br>*Частые ошибки:* `Connection refused` (нет связи/неверный порт), `Iso packet error` (неверный Rack/Slot). |
| **Actual connection** | Текущий активный канал (при использовании резервирования). |

### 1.2 Параметры конфигурации (Settings)

![Настройка соединения S7](images/s7_conn.png)

#### Основные и Временные настройки
| Параметр | Описание |
| :--- | :--- |
| **Name** | Уникальное имя соединения. |
| **Period (ms)** | Период опроса. Стандарт `1000`. S7comm достаточно быстрый, для критичных задач можно ставить `100-200` мс. |
| **Master connection** | Ссылка на основное соединение (для резервирования). |
| **Support for group requests** | **Yes** — драйвер будет автоматически "склеивать" запросы к соседним байтам в один пакет PDU (Optimization). |
| **Max. package length** | Размер PDU (Protocol Data Unit). Обычно `240` или `480` байт для старых серий, `960` для новых. |

#### Настройки контроллера (S7 / TCP)
Ключевые параметры для адресации "железа".

| Поле | Описание и аналитика |
| :--- | :--- |
| **Data type** | Тип (семейство) контроллера. <br>Влияет на алгоритмы формирования пакетов. Выберите `300` (для S7-300/400/VIPA) или `1200`/`1500` при наличии таких опций. |
| **IP/Hostname** | IP-адрес контроллера. |
| **Port** | **102** (Стандартный порт Siemens ISO-on-TCP). |
| **Rack** | **Номер корзины (шасси).** <br>• Для S7-300/400/1500: Обычно `0`. |
| **Slot** | **Номер слота CPU.** (Поле может быть ниже Rack).<br>⚠️ **Это критичный параметр:**<br>• **S7-300:** Всегда `2`.<br>• **S7-400:** Зависит от конфигурации Hardware (часто `2` или `3`).<br>• **S7-1200 / S7-1500:** Обычно `1` (или `0` для старых прошивок 1200). |

---

## ШАГ 2. Настройка переменных (Binding)

В S7 память имеет жесткую структуру. Для доступа к переменной нужно знать её область, тип и смещение (адрес).

![Настройка привязки S7](images/s7_bind.png)

### 2.1 Параметры привязки

| Поле | Описание |
| :--- | :--- |
| **Name** | Имя привязки. |
| **Tag** | Системный тег Faceplate. |
| **Access** | **R** (Read), **W** (Write). |

### 2.2 Адресация памяти (S7 Address)

Для адресации вида `DB1.DBX10.2` (Бит 2 в байте 10 блока данных 1) настройки будут выглядеть так:

| Поле | Инструкция |
| :--- | :--- |
| **Memory area** | Область памяти:<br>• **DB** — Data Block (Блоки данных, основная область).<br>• **I** (Inputs) — Входы.<br>• **Q** (Outputs) — Выходы.<br>• **M** (Flags/Merkers) — Меркерная память. |
| **Type** | Тип данных переменной:<br>• `bit` (BOOL)<br>• `byte`, `word`, `dword`<br>• `int`, `real` (float) |
| **DB** | **Номер блока данных.** Заполняется, только если `Memory area` = **DB**. (Например, `1`). |
| **Byte** | **Смещение байта (Byte Offset).** Начальный байт переменной. |
| **Bit** | **Смещение бита (Bit Offset).** От `0` до `7`. <br>Заполняется **только** если `Type` = `bit`. Для остальных типов должно быть `0`. |
| **Format** | Интерпретация данных (например, `integer` для знаковых чисел или `float` для вещественных). |

---
<!-- 
## Дополнительно

При работе с S7-1200 и S7-1500 часто возникают проблемы доступа. Если `Error` пишет "Permission denied" или данные не идут:

1.  **Optimized Block Access:**
    * Драйверы этого типа (S7comm) обычно **не умеют** работать с "Оптимизированными блоками" (символьная адресация).
    * *Решение:* В TIA Portal откройте свойства DB и **снимите** галочку "Optimized block access". После этого скомпилируйте проект и загрузите в ПЛК.
2.  **PUT/GET Access:**
    * В настройках CPU (в TIA Portal) в разделе *Protection & Security -> Connection mechanisms* должна быть **установлена** галочка: *"Permit access with PUT/GET communication from remote partner"*.
3.  **Rack/Slot:**
    * Если не удается подключиться к S7-300: Проверьте, что Rack=`0`, Slot=`2`.
    * Если не удается подключиться к S7-1200: Проверьте Rack=`0`, Slot=`1`. -->