# Руководство по конфигурации IEC 60870-5-104 Server

## Общее описание
Драйвер **IEC 104 Server** позволяет системе **Faceplate** выступать в роли контролируемого пункта (КП/Slave). В этом режиме система открывает TCP-порт и ожидает подключений от внешних управляющих систем (SCADA верхнего уровня, Пункты Управления), передавая им данные своих внутренних тегов и принимая команды управления.

Процесс настройки состоит из двух этапов:
1.  **Connection (`plc_iec104_server_connection`):** Настройка TCP-порта, адресации ASDU и временных параметров протокола.
2.  **Binding (`plc_iec104_server_binding`):** Публикация конкретных тегов в адресное пространство протокола (IOA) и настройка параметров для приема команд.

---

## ШАГ 1. Настройка соединения (Connection)

На этом этапе конфигурируется "слушающий" сокет и параметры канального уровня. Эти настройки должны соответствовать настройкам Клиента (Master), который будет подключаться к Faceplate.

![Настройка соединения IEC 104 Server](images/iec104_server.png)

### 1.1 Панель диагностики (Runtime)
Верхняя часть окна отображает состояние серверного процесса.

| Поле | Описание |
| :--- | :--- |
| **State** | **STOP** — сервер остановлен, порт закрыт.<br>**RUN** — сервер запущен и ожидает подключений. |
| **Error** | Текст ошибки (например, `Address already in use`, если порт 2404 занят другим приложением). |
| **Actual connection** | Индикатор активного соединения (актуально при резервировании серверов). |

### 1.2 Основные настройки (General Settings)

| Параметр | Описание |
| :--- | :--- |
| **Name** | Уникальное имя соединения в системе. |
| **Period (ms)** | Внутренний цикл обработки событий драйвера. |
| **Shutdown timeout (ms)** | Время на корректное закрытие TCP-сессий при остановке драйвера. |
| **Support for group requests** | **Yes** — Разрешить обработку команд "Общего опроса" (Interrogation Command) от клиента. Рекомендуется включить. |
| **Max. package length** | Максимальный размер APDU (Application Protocol Data Unit). Стандартное значение: **250**. |
| **Line Delay Ratio** | Коэффициент задержки линии (для расчета таймаутов на медленных каналах). |

### 1.3 Параметры протокола (Protocol Parameters)

| Поле | Описание |
| :--- | :--- |
| **Port** | TCP порт для входящих соединений. Стандарт IANA: **2404**. |
| **Originator Address** | Адрес инициатора, который сервер будет подставлять в свои ответы по умолчанию (обычно 0). |
| **Common Address of ASDU** | **Адрес станции (CA).** Уникальный номер этого устройства в сети IEC 104. Должен совпадать с настройками Клиента. |
| **Common Address Size** | Размер поля адреса ASDU в байтах. Стандарт: **2 bytes**. |
| **Originator Address Size** | Размер поля адреса отправителя. Стандарт: **1 byte** (иногда 0). |
| **Information Object Address Size** | Размер поля адреса объекта (IOA). Стандарт: **3 bytes**. |
| **K** | Параметр **k** (APDU transmit window). Максимальное число переданных пакетов без подтверждения. |
| **W** | Параметр **w** (APDU receive window). Максимальное число принятых пакетов до отправки подтверждения. |
| **T1 (ms)** | Тайм-аут ожидания подтверждения передачи (Time-out for send confirmation). |
| **T2 (ms)** | Тайм-аут ожидания подтверждения приема (Time-out for ack in case of no data message). |
| **T3 (ms)** | Тайм-аут теста канала (Time-out for send test frames). Интервал отправки `TESTFR`, если канал простаивает. |

**Group broadcast (Групповая рассылка):**
Позволяет настроить периодическую отправку данных определенных групп, даже если клиент не запрашивал их явно.
* *Номер группы / Частота обновления / Таймаут.*

**Принимать обновления через информационные объекты:**
Специальная опция. Если включено (**On**), то запись Клиентом значения в IOA приведет к обновлению значения привязанного тега в системе Faceplate. Используется для реализации шлюзов или приема уставок.

---

## ШАГ 2. Настройка переменных (Binding)

Этот этап определяет список сигналы, которые сервер будет отдавать "наверх".

![Настройка привязки IEC 104 Server](images/iec104_server_bindings.png)

### 2.1 Основные параметры
| Поле | Описание |
| :--- | :--- |
| **Name** | Имя объекта привязки. |
| **Tag** | **Исходный тег.** Внутренний тег Faceplate, значение которого будет транслироваться в протокол. |
| **Access** | Режим доступа для Клиента:<br>• **R** — Клиент может только читать (Мониторинг/TM).<br>• **RW** — Клиент может читать и присылать команды управления (Telecontrol/TC). |
| **Address** | **IOA (Information Object Address).** Адрес информационного объекта. Число, под которым тег виден в сети. (См. расчет ниже). |
| **Type** | **Тип ASDU.** Формат данных для передачи.<br>Примеры: `M_SP_NA_1` (ТС однопозиционный), `M_ME_NC_1` (ТИ float). |
| **Parameter** | Атрибут тега для передачи: `Value` (Значение), `Quality` (Признак качества), `Timestamp` (Метка времени). |

### Расчет полного адреса IOA
Если в карте адресов IOA задан октетами (байтами), используйте формулу (Little-Endian):
$$Address = Октет_1 + (Октет_2 \times 256) + (Октет_3 \times 65536)$$

### 2.2 Параметры Телеуправления (Remote Control)
Эти поля становятся активными и обязательными, если `Access` установлен в **RW**. Они определяют, как сервер должен обрабатывать входящие команды.

| Поле | Описание |
| :--- | :--- |
| **Remote control type** | **Тип команды.**<br>Тип ASDU, который сервер ожидает получить от клиента для воздействия на этот объект.<br>Примеры: `C_SC_NA_1` (Single Command), `C_SE_NC_1` (Setpoint Float). |
| **Remote control address** | **IOA Команды.**<br>Адрес, на который клиент должен прислать команду управления. Часто совпадает с адресом мониторинга (`Address`), но может и отличаться. |
| **Group** | Номер группы опроса (Interrogation Group), в которую входит данный сигнал (обычно 20 — General Interrogation). |

---
<!-- 
## Чек-лист системного аналитика

1.  **Сетевой доступ:** Убедитесь, что TCP-порт **2404** открыт во входящих правилах брандмауэра (Firewall) на сервере, где запущен Faceplate.
2.  **Соответствие типов:** Тип ASDU в поле `Type` — это то, как сервер *упакует* данные перед отправкой. Убедитесь, что принимающая сторона (SCADA) настроена на прием именно этого типа данных (например, отличает Float от Normalized value).
3.  **Обратная связь (RW):** Для реализации полноценного управления (TU) необходимо не только настроить `Remote control address`, но и обеспечить, чтобы изменение тега в системе Faceplate приводило к реальному действию на оборудовании. -->