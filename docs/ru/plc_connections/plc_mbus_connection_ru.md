# Руководство по конфигурации драйвера M-Bus (Meter-Bus)

## Общее описание
**M-Bus (Meter-Bus)** — это специализированный европейский стандарт (EN 13757) для дистанционного считывания данных с приборов коммерческого учета: теплосчетчиков, водосчетчиков, счетчиков газа и электроэнергии.

В системе **Faceplate** драйвер M-Bus является гибридным и поддерживает два физических уровня:
1.  **Serial (COM):** Прямое подключение к серверу через Master-конвертер уровней (M-Bus <-> RS-232/485).
2.  **TCP (Ethernet):** Подключение через удаленные шлюзы (Ethernet-to-MBus) или прозрачные конвертеры.

Архитектура настройки состоит из двух шагов:
1.  **Connection (`plc_mbus_connection`):** Настройка транспорта до шины.
2.  **Binding (`plc_mbus_binding`):** Настройка опроса конкретной переменной внутри прибора.

---

## 1. Настройка соединения (Connection)
> Создать PLC cоединения → [Шаги создания PLC соединения](./general_ru.md#создание-plc-соединения)

На этом этапе мы конфигурируем мастер-устройство, опрашивающее шину.

### 1.1 Панель диагностики
Верхняя часть окна отображает статус драйвера.
>Диагностика PLC соединения → [Диагностика](./general_ru.md#диагностика-diagnostics)


| Поле | Описание |
| :--- | :--- |
| **State** | **STOP** — драйвер остановлен.<br>**RUN** — драйвер запущен. |
| **Node** | Узел кластера. На какой ноде изполняется процесс |
|**PID**|ID процесса.|
| **Error** | Текст ошибки. |
|**Disabled**||
|**Memory limit (bytes)**| Ограничение памяти(пределы оперативной памяти (МБ) для процесса, обслуживающего соединение). Емкость памяти определяет количество переменных (тегов), которые могут быть обработаны в процессе функционирования соединения.|
| **Actual connection** | Текущий исполняемый канал связи. В системах с резервированием (Redundancy) указывает, какое именно соединение (основное или резервное) осуществляет обмен данными в текущий момент времени.|
|**Master connection**|  Привязка к основному каналу связи. Заполняется для резервных соединений. Поле указывает, какое соединение является приоритетным (Master), определяя логическую пару для механизма резервирования.|

### 1.2 Основные параметры (Settings)

| Параметр | Описание |
| :--- | :--- |
| **Name** | Уникальное имя соединения. |
| **Title** | Заголовок (описание) данного объекта. |
| **Period (ms)** | Базовый цикл обработки драйвера. |
| **Shutdown timeout (ms)** | Время ожидания корректного разрыва соединения. |
| **Support for group requests** | **Yes** — включить возможность периодического общего опроса (General Interrogation). |
| **Max. package length** | Максимальный размер APDU. Стандартно 250 байт. |
| **Line Delay Ratio** | Коэффициент задержки для медленных линий связи. |


### 1.3 Параметры Протокола (MBUS)

#### 1.3.1 Режим `serial` (Прямое подключение)
Используется, если аппаратный конвертер M-Bus подключен непосредственно к COM-порту сервера.

![Настройка Serial M-Bus](images/mbus2.png)

| Поле | Описание |
| :--- | :--- |
| **Port** | Системное имя порта (Linux: `/dev/ttyUSB0`, Win: `COM1`). |
| **Baud rate** | Скорость обмена. <br>*Стандарт:* Обычно **2400** (реже 9600). Должна совпадать с настройками приборов. |
| **Parity** | Четность. <br>*Стандарт:* Обычно **Even** (Четность). На скриншоте стоит `no`, но для большинства теплосчетчиков требуется `Even`. |
| **Data / Stop bits** | Обычно 8 бит данных и 1 стоп-бит. |
| **Timeout** | Время ожидания ответа. Для M-Bus лучше ставить с запасом (3000-5000 мс). |
|**attempts**|Количество попыток запроса. Определяет максимальное число повторных попыток отправки запроса к устройству при отсутствии ответа.|

#### 1.3.2 Режим `tcp` (Сетевой шлюз)
Используется, если шина M-Bus находится удаленно и подключена через Ethernet-конвертер.

![Настройка TCP M-Bus](images/mbus1.png)

| Поле | Описание |
| :--- | :--- |
| **IP/Hostname** | IP-адрес шлюза. |
| **Port** | TCP порт (часто `502`, `1001` или `8000` — см. документацию на шлюз). |
| **Timeout** | Учитывайте сетевые задержки + медлительность самой шины. |
|**attempts**|Количество попыток запроса. Определяет максимальное число повторных попыток отправки запроса к устройству при отсутствии ответа.|

---

##  2. Настройка переменных (Binding)

Особенность M-Bus в том, что прибор отдает **всю** информацию одним большим пакетом. Задача Binding — "выкусить" из этого пакета нужное значение.

![Настройка переменной M-Bus](images/mbus4.png)
> Создать PLC привязку → [Шаги создания PLC привязки](./general_ru.md#создание-plc-привязки)

### 2.1 Параметры привязки

| Поле | Описание |
| :--- | :--- |
| **Name** | Имя привязки. |
| **Title** | Заголовок (описание) для данного объекта. |
| **State** | **STOP** — привязка остановлена.<br>**RUN** — привязка запущен. |
| **Tag** | Системный тег Faceplate. Приходящее значение будет записано в выбранное поле выбранного объекта. Cм. [Привязка к тегу](./general_ru.md#привязка-к-тегу-на-примере-архива) |
| **Transformation** | Преобразование значения. См. [Transformation](./transformation_ru.md). |
| **Access** | **R** — Read Only (Только чтение).<br>**W** — Write (Редко используется в M-Bus).<br>**RW**-Raad/Write |
| **Address** | **Primary Address (Первичный адрес).** Число от 1 до 250. Уникальный адрес счетчика на шине. |
| **Telegram** | Номер телеграммы. Для большинства простых приборов = `0`. (Используется, если данные не влезают в один пакет). |
| **Index** | **Индекс данных в пакете.** Самый сложный параметр. <br>Это порядковый номер переменной в структуре ответа M-Bus. <br>*Пример:* Если счетчик шлет последовательность: [Время, Энергия, Расход, Температура], то для получения Энергии Index = `1` (или `0`, зависит от реализации драйвера, начните с 0). |


>Ошибка в PLC привязке -> [ошибка привязки](./general_ru.md#ошибка-в-привязке)
---
