
# Руководство по конфигурации Modbus (TCP/RTU)

## Общее описание
**Modbus** — это де-факто стандарт промышленной автоматизации. В системе **Faceplate** реализован универсальный драйвер, поддерживающий три режима работы, что позволяет опрашивать как современные контроллеры, так и устаревшее оборудование или датчики через шлюзы.

Поддерживаемые режимы (`Type`):
1.  **tcp:** Классический Modbus TCP (Ethernet).
2.  **rtu-serial:** Modbus RTU через физический COM-порт (RS-485/232).
3.  **rtu-tcp:** Modbus RTU инкапсулированный в TCP пакет (Modbus-over-TCP). Используется для работы с прозрачными шлюзами (Moxa, HF и др.).

Процесс настройки состоит из двух этапов:
1.  **Connection (`plc_modbus_connection`):** Настройка транспорта.
2.  **Binding (`plc_modbus_binding`):** Адресация регистров.

---

## ШАГ 1. Настройка соединения (Connection)

На этом этапе мы выбираем физику связи.

### 1.1 Выбор типа транспорта
Первым делом определите тип подключения в поле **Type**.

![Выбор типа Modbus](images/modbus_type.png)

### 1.2 Базовые настройки (Общие для всех типов)

| Параметр | Описание и рекомендации |
| :--- | :--- |
| **Name** | Уникальное имя соединения. |
| **Period (ms)** | Период опроса (по умолчанию `1000`). <br>*Совет:* Для Serial ставьте >100-200 мс. Для TCP можно быстрее. |
| **Shutdown timeout** | Время ожидания закрытия сокета (`60000`). |
| **Support for group requests** | **Yes** — включить групповое чтение регистров (оптимизация). Драйвер будет читать подряд идущие адреса одним запросом. |
| **Max. package length** | Ограничение длины PDU. Если шлюз имеет малый буфер, уменьшите значение (стандарт 250). |

---

### 1.3 Настройка физического уровня

#### Вариант А: Режим `tcp` (Ethernet)
Используется для связи с ПЛК или модулями ввода-вывода, имеющими Ethernet-порт и поддерживающими стек Modbus TCP.

![Настройка Modbus TCP](images/tcp.png)

| Поле | Описание |
| :--- | :--- |
| **IP/Hostname** | IP-адрес устройства (например, `192.168.1.10`). |
| **Port** | Стандартный порт Modbus TCP — **502**. |
| **Timeout** | Время ожидания ответа сервера (в мс). |
| **Attempts** | Количество повторных попыток перед ошибкой связи. |

#### Вариант Б: Режим `rtu-serial` (RS-485/232)
Используется для прямого подключения гирлянды устройств к COM-порту сервера.

![Настройка Modbus RTU Serial](images/rtu_serial.png)

| Поле | Описание |
| :--- | :--- |
| **Port** | Путь к порту (Linux: `/dev/ttyUSB0`, Windows: `COM1`). |
| **Baud rate** | Скорость. Должна строго совпадать на всех устройствах линии (9600, 19200 и т.д.). |
| **Parity** | Четность (`no`, `even`, `odd`). |
| **Stop bits / Data bits** | Обычно `1` и `8`. |
| **Line Delay Ratio** | Коэффициент задержки линии. Увеличьте, если линия длинная и "шумная". |

> **Примечание:** Режим **rtu-tcp** настраивается аналогично режиму TCP (нужен IP и Порт), но структура пакета внутри будет как у RTU (с контрольной суммой CRC).

---

## ШАГ 2. Настройка переменных (Binding)

Здесь мы привязываем конкретный регистр Modbus к тегу системы.

![Настройка Binding Modbus](images/bindings.png)

### 2.1 Адресация (Addressing)

| Поле | Описание |
| :--- | :--- |
| **Slave address** | Адрес устройства (Unit ID). В TCP обычно `1` (или `255`), в Serial — от `1` до `247`. |
| **Memory area** | Тип памяти Modbus:<br>• **HR** (Holding Registers) — 4xxxx, чтение/запись.<br>• **IR** (Input Registers) — 3xxxx, только чтение.<br>• **CS** (Coils) — 0xxxx, биты чтение/запись.<br>• **IS** (Discrete Inputs) — 1xxxx, биты только чтение. |
| **Address** | Смещение (Offset) адреса регистра. <br>*Внимание:* В некоторых картах адресов нумерация начинается с 1, в драйвере обычно с 0. Если данные "сдвинуты", попробуйте +/- 1. |
| **Read / Write** | Коды функций Modbus. Обычно выставляются автоматически при выборе Memory Area (например, Read `03`, Write `10` или `06`). |

### 2.2 Формат данных (Data Handling)

| Поле | Описание |
| :--- | :--- |
| **The size** | Размер данных (Word = 16 бит, DWord = 32 бита и т.д.). |
| **Format** | Интерпретация данных: `signed-integer` (со знаком), `unsigned`, `float` (вещественное). |
| **Byte order** | **Порядок байт.** Критически важная настройка.<br>• `21` — Big Endian (стандарт).<br>• `12` — Little Endian.<br>• `2143` / `3412` — Различные варианты Swap для 32-битных чисел. Подбирается экспериментально, если число отображается неверно. |
| **Check CRC** | Принудительная проверка контрольной суммы (обычно `Yes`). |

---

<!-- ## Дополнительно

1.  **Сдвиг адреса:** Самая частая проблема Modbus. Если вы ожидаете значение в регистре `100`, а видите `0`, попробуйте адрес `99` или `101`.
2.  **Порядок байт (Endianness):** Если вместо температуры `25.0` вы видите огромное число или `0.0004` — меняйте настройку **Byte order**.
3.  **Таймауты:** Для RTU Serial всегда ставьте таймауты с запасом (минимум 100-200 мс), так как RS-485 — полудуплексный интерфейс.
4.  **IP-адресация:** При использовании `rtu-tcp` (шлюзов) убедитесь, что **Slave Address** соответствует адресу устройства НА ШИНЕ RS-485 за шлюзом, а не IP-адресу самого шлюза. -->